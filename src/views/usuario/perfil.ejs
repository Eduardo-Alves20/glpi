<section class="page usuario-perfil-page">
  <div class="page__top">
    <div>
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="/app">Home</a>
        <span>/</span>
        <a href="/usuario">Usuario</a>
        <span>/</span>
        <strong>Meu perfil</strong>
      </nav>

      <h1 class="page__title">Meu perfil</h1>
      <p class="page__subtitle">Atualize seus dados e gerencie a senha com seguranca.</p>
    </div>
  </div>

  <% if (typeof flash !== "undefined" && flash) { %>
    <script>
      window.__FLASH__ = <%- JSON.stringify({
        tipo: String(flash.tipo || "info").toLowerCase(),
        mensagem: String(flash.mensagem || "").slice(0, 300)
      }) %>;
    </script>
  <% } %>

  <% if (typeof erroGeral !== "undefined" && erroGeral) { %>
    <div class="alert alert--danger"><%= erroGeral %></div>
  <% } %>

  <div class="card">
    <div class="card__header">
      <h2 class="card__title">Dados da conta</h2>
      <p class="card__hint">Login e perfil nao podem ser alterados aqui.</p>
    </div>

    <form class="form" method="post" action="/usuario/perfil" autocomplete="off" novalidate>
      <div class="form__grid">
        <div class="form__field">
          <label class="form__label" for="usuario">Usuario (login)</label>
          <input class="form__input" id="usuario" type="text" value="<%= valores?.usuario || '' %>" disabled />
        </div>

        <div class="form__field">
          <label class="form__label" for="perfil">Perfil</label>
          <input class="form__input" id="perfil" type="text" value="<%= valores?.perfil || '' %>" disabled />
        </div>

        <div class="form__field form__field--full">
          <label class="form__label" for="nome">Nome</label>
          <input
            class="form__input"
            id="nome"
            name="nome"
            type="text"
            minlength="3"
            maxlength="120"
            required
            value="<%= valores?.nome || '' %>"
          />
        </div>

        <div class="form__field form__field--full">
          <label class="form__label" for="email">E-mail</label>
          <input
            class="form__input"
            id="email"
            name="email"
            type="email"
            maxlength="254"
            required
            value="<%= valores?.email || '' %>"
          />
        </div>
      </div>

      <div class="form__actions">
        <button class="btn btn--primary" type="submit">Salvar dados</button>
        <a class="btn btn--ghost" href="/app">Cancelar</a>
      </div>
    </form>
  </div>

  <div class="card">
    <div class="card__header card__header--inline">
      <div>
        <h2 class="card__title">Seguranca</h2>
        <p class="card__hint">Para alterar senha, abra o modal de redefinicao.</p>
      </div>
      <button type="button" class="btn btn--ghost" id="btnAbrirModalSenha">Trocar senha</button>
    </div>
  </div>

  <div class="senha-modal" id="senhaModal" hidden>
    <div class="senha-modal__backdrop" data-close-modal="true"></div>
    <div class="senha-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="senhaModalTitulo">
      <div class="senha-modal__header">
        <h2 id="senhaModalTitulo">Redefinir senha</h2>
        <button type="button" class="senha-modal__close" data-close-modal="true" aria-label="Fechar">x</button>
      </div>

      <form class="senha-form" method="post" action="/usuario/perfil/senha" autocomplete="off">
        <div class="form__grid">
          <div class="form__field form__field--full">
            <label class="form__label" for="senhaAtual">Senha atual</label>
            <div class="pw-field">
              <input
                class="form__input pw-input"
                id="senhaAtual"
                name="senhaAtual"
                type="password"
                autocomplete="current-password"
                required
              />
              <button class="pw-toggle" type="button" data-toggle-pw="senhaAtual" aria-label="Mostrar senha">
                ğŸ‘
              </button>
            </div>
          </div>

          <div class="form__field">
            <label class="form__label" for="senhaNova">Nova senha</label>
            <div class="pw-field">
              <input
                class="form__input pw-input"
                id="senhaNova"
                name="senhaNova"
                type="password"
                autocomplete="new-password"
                minlength="8"
                maxlength="72"
                required
              />
              <button class="pw-toggle" type="button" data-toggle-pw="senhaNova" aria-label="Mostrar senha">
                ğŸ‘
              </button>
            </div>
            <small class="form__help">Minimo de 8 caracteres.</small>
          </div>

          <div class="form__field">
            <label class="form__label" for="senhaNovaConfirmacao">Confirmar nova senha</label>
            <div class="pw-field">
              <input
                class="form__input pw-input"
                id="senhaNovaConfirmacao"
                name="senhaNovaConfirmacao"
                type="password"
                autocomplete="new-password"
                minlength="8"
                maxlength="72"
                required
              />
              <button class="pw-toggle" type="button" data-toggle-pw="senhaNovaConfirmacao" aria-label="Mostrar senha">
                ğŸ‘
              </button>
            </div>
          </div>
        </div>

        <div class="form__actions">
          <button class="btn btn--primary" type="submit">Alterar senha</button>
          <button class="btn btn--ghost" type="button" data-close-modal="true">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  (function () {
    const modal = document.getElementById("senhaModal");
    const openBtn = document.getElementById("btnAbrirModalSenha");
    if (!modal || !openBtn) return;

    const startOpen = <%= abrirModalSenha ? "true" : "false" %>;

    function closeModal() {
      modal.setAttribute("hidden", "");
      document.body.classList.remove("perfil-modal-open");
    }

    function openModal() {
      modal.removeAttribute("hidden");
      document.body.classList.add("perfil-modal-open");
      const first = document.getElementById("senhaAtual");
      if (first) first.focus();
    }

    openBtn.addEventListener("click", openModal);

    modal.querySelectorAll('[data-close-modal="true"]').forEach((el) => {
      el.addEventListener("click", closeModal);
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && !modal.hasAttribute("hidden")) {
        closeModal();
      }
    });

    document.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;

      const btnPw = target.closest("[data-toggle-pw]");
      if (!btnPw) return;

      const inputId = btnPw.getAttribute("data-toggle-pw");
      const input = document.getElementById(inputId);
      if (!input) return;

      const isPassword = input.getAttribute("type") === "password";
      input.setAttribute("type", isPassword ? "text" : "password");
      btnPw.setAttribute("aria-label", isPassword ? "Ocultar senha" : "Mostrar senha");
      btnPw.textContent = isPassword ? "ğŸ™ˆ" : "ğŸ‘";
    });

    if (startOpen) openModal();
  })();
</script>
