<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="icon" href="/assets/favicon.ico" />
    <title><%= (typeof titulo !== "undefined" && titulo) ? titulo : "GLPI" %></title>

    <link rel="stylesheet" href="/styles/index.css" />
    <link rel="stylesheet" href="/styles/sidebar.css" />
    <link rel="stylesheet" href="/styles/app.css" />

    <% if (typeof cssExtra !== "undefined" && cssExtra) { %>
      <link rel="stylesheet" href="<%= cssExtra %>" />
    <% } %>
    <% if (typeof cssPortal !== "undefined" && cssPortal) { %>
      <link rel="stylesheet" href="<%= cssPortal %>" />
    <% } %>

  

    <% if (typeof jsExtra !== "undefined" && jsExtra) { %>
      <% (Array.isArray(jsExtra) ? jsExtra : [jsExtra]).forEach((src) => { %>
        <script src="<%= src %>" defer></script>
      <% }) %>
    <% } %>
  </head>

  <body class="app-layout" data-perfil="<%= usuarioSessao?.perfil || '' %>">
    <button id="notifBell" type="button" class="notif-btn" aria-label="Notifica√ß√µes">
  üîî <span id="notifBadge" hidden>0</span>
</button>
<div id="notifDropdown" hidden>
  <div id="notifListMini"></div>
  <a href="/notificacoes">Ver todas</a>
</div>
    <div class="app-shell">
      <%- include("partials/sidebar") %>

      <main class="app-main">
        <%- body %>
      </main>
    </div>

    <!-- Bot√£o para permitir notifica√ß√µes do browser -->
    <button id="btnNotify" type="button" style="
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(15,31,55,.18);
      background: #fff;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 8px 22px rgba(0,0,0,.12);
    ">
      Ativar notifica√ß√µes
    </button>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <% if (typeof flash !== "undefined" && flash) { %>
      <script>
        window.__FLASH__ = <%- JSON.stringify({
          tipo: String(flash.tipo || "info").toLowerCase(),
          mensagem: String(flash.mensagem || "").slice(0, 300),
        }) %>;
      </script>
    <% } %>
    <script src="/js/alerts.js"></script>

    <script>
      // pede permiss√£o s√≥ quando o usu√°rio clicar
      (function () {
        const btn = document.getElementById("btnNotify");
        if (!btn) return;

        btn.addEventListener("click", async () => {
          try {
            if (!("Notification" in window)) {
              Swal.fire({ icon: "info", title: "N√£o suportado", text: "Seu navegador n√£o suporta notifica√ß√µes." });
              return;
            }
            const perm = await Notification.requestPermission();
            if (perm === "granted") {
              Swal.fire({ icon: "success", title: "Ok!", text: "Notifica√ß√µes ativadas." });
              btn.style.display = "none";
            } else {
              Swal.fire({ icon: "warning", title: "Permiss√£o negada", text: "Voc√™ pode ativar nas configura√ß√µes do navegador." });
            }
          } catch (e) {}
        });

        // se j√° est√° granted, some
        if ("Notification" in window && Notification.permission === "granted") {
          btn.style.display = "none";
        }
      })();
    </script>
    <script type="module">
      import { startNotificacoesPoll } from "/js/notificacoes-poll.js";
      startNotificacoesPoll({
        perfil: "<%= String(usuarioSessao?.perfil || '') %>",
      });
    </script>
  </body>
</html>
