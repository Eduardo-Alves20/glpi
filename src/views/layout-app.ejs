<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="icon" href="/assets/favicon.ico" />
    <title><%= (typeof titulo !== "undefined" && titulo) ? titulo : "GLPI" %></title>

    <script>
      (function () {
        try {
          const saved = String(localStorage.getItem("glpi-theme") || "").trim().toLowerCase();
          const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
          const useDark = saved ? saved === "dark" : prefersDark;
          if (useDark) document.documentElement.classList.add("dark-mode");
        } catch {}
      })();
    </script>

    <link rel="stylesheet" href="/styles/index.css" />
    <link rel="stylesheet" href="/styles/sidebar.css" />
    <link rel="stylesheet" href="/styles/app.css" />

    <% if (typeof cssExtra !== "undefined" && cssExtra) { %>
      <link rel="stylesheet" href="<%= cssExtra %>" />
    <% } %>
    <% if (typeof cssPortal !== "undefined" && cssPortal) { %>
      <link rel="stylesheet" href="<%= cssPortal %>" />
    <% } %>
    <link rel="stylesheet" href="/styles/dark-mode-fixes.css" />

    <% if (typeof jsExtra !== "undefined" && jsExtra) { %>
      <% (Array.isArray(jsExtra) ? jsExtra : [jsExtra]).forEach((src) => { %>
        <script src="<%= src %>" defer></script>
      <% }) %>
    <% } %>
  </head>

  <body class="app-layout" data-perfil="<%= usuarioSessao?.perfil || '' %>">
    <button id="notifBell" type="button" class="notif-btn" aria-label="Notificacoes" hidden>
      &#128276; <span id="notifBadge" hidden>0</span>
    </button>
    <div id="notifDropdown" hidden>
      <div class="notif-mini-head">
        <strong class="notif-mini-title">Notificacoes</strong>
        <a class="notif-see-all" href="/notificacoes">Ver todas</a>
      </div>
      <div id="notifListMini" class="notif-mini-list"></div>
    </div>

    <div class="app-shell">
      <%- include("partials/sidebar") %>

      <main class="app-main">
        <%- body %>
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <% if (typeof flash !== "undefined" && flash) { %>
      <script>
        window.__FLASH__ = <%- JSON.stringify({
          tipo: String(flash.tipo || "info").toLowerCase(),
          mensagem: String(flash.mensagem || "").slice(0, 300),
        }) %>;
      </script>
    <% } %>
    <script src="/js/alerts.js"></script>
    <script src="/js/anexos-assist.js" defer></script>
    <script src="/js/app.js" defer></script>

    <script type="module">
      import { startNotificacoesPoll } from "/js/notificacoes-poll.js";
      startNotificacoesPoll({
        perfil: "<%= String(usuarioSessao?.perfil || '') %>",
      });
    </script>
  </body>
</html>
